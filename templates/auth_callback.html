<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Processando Login...</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #111;
            color: #fff;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="spinner"></div>
    <h3>Conectando com Google...</h3>
    <p id="status">Aguarde um momento.</p>

    <script>
        // Supabase Auth sends the session in the URL hash fragment
        // #access_token=...&refresh_token=...&expires_in=...&token_type=bearer&type=recovery

        function processHash() {
            // Priority: Check for 'code' query param (Supabase Auth Code Flow / PKCE)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error_description') || urlParams.get('error');

            if (code) {
                document.getElementById('status').innerText = 'Código recebido. Trocando por sessão...';

                // Exchange code for session
                fetch('/auth/set_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/';
                        } else {
                            document.getElementById('status').innerText = 'Erro na troca de código: ' + data.error;
                        }
                    })
                    .catch(error => {
                        document.getElementById('status').innerText = 'Erro de conexão: ' + error;
                    });
                return;
            }

            // Fallback: Check for Hash (Implicit Flow - unusual for server-side redirect but possible)
            const hash = window.location.hash.substring(1);
            if (hash.includes('access_token')) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');

                if (accessToken) {
                    document.getElementById('status').innerText = 'Token recebido via Hash. Criando sessão...';

                    fetch('/auth/set_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = '/';
                            } else {
                                document.getElementById('status').innerText = 'Erro ao criar sessão: ' + data.error;
                            }
                        })
                        .catch(error => {
                            document.getElementById('status').innerText = 'Erro de conexão: ' + error;
                        });
                    return;
                }
            }

            // Error Handling
            if (error) {
                document.getElementById('status').innerHTML = 'Erro no login: ' + error +
                    '<br><a href="/login" class="btn" style="color: #3b82f6; margin-top: 10px; display:inline-block;">Voltar para Login</a>';
            } else {
                // Determine if we should redirect or show error
                document.getElementById('status').innerHTML = 'Token ou Código não encontrado.' +
                    '<br><a href="/login" class="btn" style="color: #3b82f6; margin-top: 10px; display:inline-block;">Voltar para Login</a>';
            }
        }

        processHash();
    </script>
</body>

</html>